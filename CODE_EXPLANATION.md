# コードベース解説ドキュメント

このドキュメントでは、リファクタリング後の周波数解析データセットプロジェクトのコード構造と、各モジュールの役割について解説します。

## ディレクトリ構造

```
project_root/
├── main.py                # エントリーポイント (CLI)
├── src/                   # ソースコードパッケージ
│   ├── __init__.py
│   ├── config.py          # 設定ファイル
│   ├── io_handler.py      # 入出力・前処理 (バイナリ変換, トリミング)
│   ├── analyzer.py        # 解析ロジック (FFT, 統計, バンド解析)
│   ├── pipeline.py        # 処理フローの定義 (各ステップの実行関数)
│   └── visualizer.py      # 可視化・グラフ生成
└── CODE_EXPLANATION.md    # 本ドキュメント
```

---

## 各モジュールの詳細

### 1. `main.py` (エントリーポイント)
解析パイプラインの実行を管理するスクリプトです。コマンドライン引数を受け取り、`src/pipeline.py` 内の適切な関数を呼び出します。

- **主な機能**:
    - コマンドライン引数 (`--convert`, `--trim`, `--analyze` など) の解析。
    - `src/config.py` で定義された「解析対象フォルダ」へのループ処理。
- **使用方法**: `python main.py --all` ですべての工程を実行できます。

### 2. `src/config.py` (設定)
プロジェクト全体の設定パラメータを一元管理します。

- **主な設定項目**:
    - `target_folders`: 解析対象のフォルダパス（リスト）。
    - `sampling_rate`: サンプリング周波数 (基本 1000Hz)。
    - `fft_binned_stats`: 10Hz区切りの統計解析の設定 (`bin_size`, `max_freq`)。
    - `fft_diff_bin_size`: 差分解析時の周波数解像度 (1Hz)。
    - ディレクトリ名・ファイル名の定義。

### 3. `src/io_handler.py` (入出力・前処理)
ファイルの読み書きや形式変換を担当します。

- **`BinaryConverter` クラス**:
    - `.bin` 形式のバイナリデータを読み込み、物理量に変換して `.csv` として保存します。
- **`trim_csv_files_in_folder` 関数**:
    - CSVファイルの先頭・末尾から指定行数を削除（トリミング）し、解析用データを準備します。

### 4. `src/analyzer.py` (解析ロジック)
データ解析の中核となるクラス `UnifiedAnalyzer` を提供します。

- **`calculate_fft`**: FFT（高速フーリエ変換）を実行し、周波数と振幅を返します。
- **`calculate_statistics`**: 基本的な統計量（平均、最大、歪度、尖度など）を計算します。
- **`get_binned_stats` (重要)**:
    - 指定された周波数バンド（例: 0-10Hz, 10-20Hz...）ごとの詳細な統計を計算します。
    - **正規化エネルギー (`energy_ratio`)**: そのバンドのエネルギーが全周波数エネルギーに占める割合（寄与率）を計算し、比較分析の公平性を保ちます。
- **`aggregate_binned_diff_stats`**:
    - 差分データに対しても同様にバンドごとの集約（差分の総和など）を行います。

### 5. `src/pipeline.py` (パイプライン)
解析の各工程（ステップ）を定義し、連携させます。

- **`run_conversion`**: バイナリ変換を実行。
- **`run_trimming`**: トリミングを実行。
- **`run_basic_analysis`**:
    - FFT計算、基本統計量に加え、`analyzer.get_binned_stats` を呼び出して **10Hz区切りの統計CSV** を生成・保存します。
- **`run_diff_analysis`**:
    - 異なるデータ（交換前vs交換後など）のFFT差分を計算します。
    - 差分の統計量に加え、**バンド別差分統計** も計算し保存します。
- **`run_visualization`**: 可視化処理を実行します。

### 6. `src/visualizer.py` (可視化)
グラフの描画を担当します。

- **基本グラフ**: 時系列波形、FFTスペクトル。
- **推移グラフ**: `plot_statistics_evolution` で統計量の時系列変化を描画。
- **複合グラフ (`plot_combined_evolution`)**:
    - 上段に「統計量の推移（エネルギーなど）」、下段に「差分の推移」を対応させて表示し、異常発生と数値変動の相関を視覚的に捉えやすくします。
